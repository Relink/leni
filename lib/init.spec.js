'use strict';

var chai = require('chai');
chai.use(require('sinon-chai'));
var expect = chai.expect;
var sinon = require('sinon');
var EventEmitter = require('events').EventEmitter;
var proxyquire = require('proxyquire').noCallThru();

var init = proxyquire('./init', {
  'kafka-node': {}
});

describe('init', function () {
  var e1;

  beforeEach(function () {
    e1 = new EventEmitter();
  });

  describe('_initOnReady', function () {

    it('rejects the initial promise if emitter returns immediate error', function (done) {
      init._initOnReady(e1).catch(function (err) {
        expect(err).to.be.an('error');
        expect(err.message).to.match(/bar/);
        done();
      });
      e1.emit('error', new Error('bar'));
    });

    it('Resolves to the producer when ready is emitted before any errors', function (done) {
      init._initOnReady(e1).then(function (ee) {
        expect(ee).to.be.instanceof(EventEmitter);
        done();
      }).catch(function (err) {
        return done(err);
      });

      e1.emit('ready');
      e1.emit('error', new Error('should not be caught'));
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbml0LnNwZWMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJLE9BQU8sUUFBUSxNQUFSLENBQVA7QUFDSixLQUFLLEdBQUwsQ0FBUyxRQUFRLFlBQVIsQ0FBVDtBQUNBLElBQUksU0FBUyxLQUFLLE1BQUw7QUFDYixJQUFJLFFBQVEsUUFBUSxPQUFSLENBQVI7QUFDSixJQUFJLGVBQWUsUUFBUSxRQUFSLEVBQWtCLFlBQWxCO0FBQ25CLElBQUksYUFBYSxRQUFRLFlBQVIsRUFBc0IsVUFBdEIsRUFBYjs7QUFFSixJQUFJLE9BQU8sV0FBVyxRQUFYLEVBQXFCO0FBQzlCLGdCQUFjLEVBQWQ7Q0FEUyxDQUFQOztBQUlKLFNBQVMsTUFBVCxFQUFpQixZQUFNO0FBQ3JCLE1BQUksRUFBSixDQURxQjs7QUFHckIsYUFBVyxZQUFLO0FBQ2QsU0FBSyxJQUFJLFlBQUosRUFBTCxDQURjO0dBQUwsQ0FBWCxDQUhxQjs7QUFPckIsV0FBUyxjQUFULEVBQXlCLFlBQU07O0FBRTdCLE9BQUcsZ0VBQUgsRUFBcUUsZ0JBQVE7QUFDM0UsV0FBSyxZQUFMLENBQWtCLEVBQWxCLEVBQ0csS0FESCxDQUNTLGVBQU87QUFDWixlQUFPLEdBQVAsRUFBWSxFQUFaLENBQWUsRUFBZixDQUFrQixFQUFsQixDQUFxQixPQUFyQixFQURZO0FBRVosZUFBTyxJQUFJLE9BQUosQ0FBUCxDQUFvQixFQUFwQixDQUF1QixLQUF2QixDQUE2QixLQUE3QixFQUZZO0FBR1osZUFIWTtPQUFQLENBRFQsQ0FEMkU7QUFPM0UsU0FBRyxJQUFILENBQVEsT0FBUixFQUFpQixJQUFJLEtBQUosQ0FBVSxLQUFWLENBQWpCLEVBUDJFO0tBQVIsQ0FBckUsQ0FGNkI7O0FBWTdCLE9BQUcsa0VBQUgsRUFBdUUsZ0JBQVE7QUFDN0UsV0FBSyxZQUFMLENBQWtCLEVBQWxCLEVBQ0csSUFESCxDQUNRLGNBQU07QUFDVixlQUFPLEVBQVAsRUFBVyxFQUFYLENBQWMsRUFBZCxDQUFpQixVQUFqQixDQUE0QixZQUE1QixFQURVO0FBRVYsZUFGVTtPQUFOLENBRFIsQ0FLRyxLQUxILENBS1M7ZUFBTyxLQUFLLEdBQUw7T0FBUCxDQUxULENBRDZFOztBQVE3RSxTQUFHLElBQUgsQ0FBUSxPQUFSLEVBUjZFO0FBUzdFLFNBQUcsSUFBSCxDQUFRLE9BQVIsRUFBaUIsSUFBSSxLQUFKLENBQVUsc0JBQVYsQ0FBakIsRUFUNkU7S0FBUixDQUF2RSxDQVo2QjtHQUFOLENBQXpCLENBUHFCO0NBQU4sQ0FBakIiLCJmaWxlIjoiaW5pdC5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGNoYWkgPSByZXF1aXJlKCdjaGFpJyk7XG5jaGFpLnVzZShyZXF1aXJlKCdzaW5vbi1jaGFpJykpO1xudmFyIGV4cGVjdCA9IGNoYWkuZXhwZWN0O1xudmFyIHNpbm9uID0gcmVxdWlyZSgnc2lub24nKTtcbnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7XG52YXIgcHJveHlxdWlyZSA9IHJlcXVpcmUoJ3Byb3h5cXVpcmUnKS5ub0NhbGxUaHJ1KCk7XG5cbnZhciBpbml0ID0gcHJveHlxdWlyZSgnLi9pbml0Jywge1xuICAna2Fma2Etbm9kZSc6IHt9XG59KTtcblxuZGVzY3JpYmUoJ2luaXQnLCAoKSA9PiB7XG4gIHZhciBlMTtcblxuICBiZWZvcmVFYWNoKCgpID0+e1xuICAgIGUxID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICB9KTtcblxuICBkZXNjcmliZSgnX2luaXRPblJlYWR5JywgKCkgPT4ge1xuXG4gICAgaXQoJ3JlamVjdHMgdGhlIGluaXRpYWwgcHJvbWlzZSBpZiBlbWl0dGVyIHJldHVybnMgaW1tZWRpYXRlIGVycm9yJywgZG9uZSA9PiB7XG4gICAgICBpbml0Ll9pbml0T25SZWFkeShlMSlcbiAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgZXhwZWN0KGVycikudG8uYmUuYW4oJ2Vycm9yJyk7XG4gICAgICAgICAgZXhwZWN0KGVyci5tZXNzYWdlKS50by5tYXRjaCgvYmFyLyk7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KVxuICAgICAgZTEuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ2JhcicpKVxuICAgIH0pO1xuXG4gICAgaXQoJ1Jlc29sdmVzIHRvIHRoZSBwcm9kdWNlciB3aGVuIHJlYWR5IGlzIGVtaXR0ZWQgYmVmb3JlIGFueSBlcnJvcnMnLCBkb25lID0+IHtcbiAgICAgIGluaXQuX2luaXRPblJlYWR5KGUxKVxuICAgICAgICAudGhlbihlZSA9PiB7XG4gICAgICAgICAgZXhwZWN0KGVlKS50by5iZS5pbnN0YW5jZW9mKEV2ZW50RW1pdHRlcik7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyID0+IGRvbmUoZXJyKSk7XG5cbiAgICAgIGUxLmVtaXQoJ3JlYWR5Jyk7XG4gICAgICBlMS5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignc2hvdWxkIG5vdCBiZSBjYXVnaHQnKSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=